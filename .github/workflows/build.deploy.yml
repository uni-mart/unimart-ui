# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: CI CD Pipeline for UI Deployment

on:
  push:
    branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest
    concurrency: ci-${{github.ref}}
    
    steps:
      - name: Setup Node.js and npm
        uses: actions/setup-node@v2
        id: setup-environment
        with:
          node-version: '16.16.0'
          npm-version: '8.11.0'

      - name: Checkout UI repository
        uses: actions/checkout@v2
        id: checkout-ui
        with:
          repository: uni-mart/unimart-ui
          ref: main
          path: ui
          
      - name: Install dependencies, build and preview UI
        working-directory: ui
        run: |
          npm install
          npm run build
          npm run preview &

      - name: Checkout UI-Automation repository
        uses: actions/checkout@v2
        id: checkout-ui-automation
        with:
          repository: uni-mart/unimart-ui-automation
          ref: main
          path: ui-automation

      - name: Run Cypress tests
        id: run-cypress-test
        working-directory: ui-automation
        run: |
          npm install
          npm run cy:runHeadless
          npm run cy:genReport
          ls -1 | xargs -n 1 echo
          
      - name: Build & push Docker image
        uses: mr-smithers-excellent/docker-build-push@v6
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        with:
          dockerfile: ui/Dockerfile
          image: bitcode001/unimart/ui
          tags: ${{github.run_number}}, latest
          registry: docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_PASSWORD }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3.7.0
        with:
          github_token: ${{ secrets.PERSONAL_TOKEN }}
          publish_dir: ui-automation/allure-report
          publish_branch: allure-report
          commit_message: Deployed Allure Report v.${{github.run_number}} to GitHub Pages
